# Storage Authority Model: Канонічна специфікація

> Створено: 2026-02-15
> Автор: Головний архітектор системи
> Статус: Канонічна специфікація
> Мова: Українська (канонічна)
> Частина: RUNTIME_ARCHITECTURE_INDEX.md

---

## 0. Призначення

Цей документ описує **storage authority model** — хто має право писати що і куди. Він визначає:

- MinIO як canonical source of truth
- Write authority per component
- Read authority per component
- Anti-patterns (хто НЕ повинен писати куди)

**[ПРИНЦИП]** У системі є рівно **одне** canonical storage — MinIO. Усі інші компоненти є або writers (з обмеженою authority), або readers (через Worker proxy).

---

## 1. Storage Hierarchy

```
┌────────────────────────────────────────────────┐
│              MinIO (Canonical Storage)           │
│                                                  │
│  Tier 1: Source of Truth                         │
│  ├── agents/{slug}/_agent.md      (definition)   │
│  ├── agents/{slug}/sources/       (knowledge)    │
│  ├── agents/{slug}/memory/        (agent memory) │
│  └── system/                      (policies)     │
│                                                  │
│  Tier 2: Operational State                       │
│  ├── agents/{slug}/runs/          (run logs)     │
│  ├── agents/{slug}/proposals/     (proposals)    │
│  └── audit/                       (audit trail)  │
│                                                  │
│  Tier 3: Cache/Index                             │
│  └── agents/index.json            (registry)     │
│                                                  │
├────────────────────────────────────────────────┤
│       garden-bloom-memory (Git Monorepo)          │
│                                                  │
│  Tier 1: Agent Memory (Layer 1 — auto-load)      │
│  ├── memory/{agentId}/snapshot.md  (≤2K tokens)  │
│  ├── memory/{agentId}/facts.md     (≤8K tokens)  │
│  └── memory/{agentId}/open_loops.md(≤2K tokens)  │
│                                                  │
│  Tier 2: Agent Memory (Layer 2 — explicit only)  │
│  ├── memory/{agentId}/decisions.md               │
│  ├── memory/{agentId}/changelog.md               │
│  └── memory/{agentId}/runs/                      │
│                                                  │
│  Tier 3: Agent Logic (versioned)                 │
│  ├── logic/{agentId}/current.drakon.json         │
│  ├── logic/{agentId}/current.pseudo.md           │
│  └── logic/{agentId}/versions/                   │
│                                                  │
├────────────────────────────────────────────────┤
│              GitHub (Content Persistence)         │
│  ├── notes/                       (published)    │
│  └── drakon/                      (committed)    │
│                                                  │
├────────────────────────────────────────────────┤
│              Cloudflare KV (Session/Auth)         │
│  ├── auth/                        (tokens)       │
│  ├── zones/                       (zone config)  │
│  └── sessions/                    (user sessions)│
└────────────────────────────────────────────────┘
```

---

## 2. Write Authority Matrix

### 2.1 MinIO writes

| Path | Canonical Writer | Коли | Інші дозволені writers |
|------|-----------------|------|----------------------|
| `agents/{slug}/_agent.md` | Owner (через Worker) | Agent definition create/update | — |
| `agents/{slug}/sources/*` | Owner (через Worker) | Upload knowledge sources | — |
| `agents/{slug}/pseudocode.md` | Owner (через Worker) | Behavioral contract update | — |
| `agents/{slug}/drakon/*` | Owner (через Worker) | DRAKON diagram save | — |
| `memory/{agentId}/*` (git monorepo) | Gateway (via Proposal `memory-update`) | Post-run memory update через Proposal lifecycle | — |
| `logic/{agentId}/current.*` (git monorepo) | Gateway (via Proposal `logic-update`) | Logic versioning через Proposal lifecycle (завжди human review) | — |
| `agents/{slug}/runs/{runId}/status.json` | **Orchestration Layer wrapper** | Run lifecycle updates | Worker (initial `requested`) |
| `agents/{slug}/runs/{runId}/manifest.json` | Orchestration Layer wrapper | Run finalize | — |
| `agents/{slug}/runs/{runId}/steps/*.json` | Orchestration Layer wrapper | Step completion | — |
| `agents/{slug}/proposals/{propId}.json` | Orchestration Layer wrapper | Proposal creation | Worker (status transitions) |
| `audit/*` | Worker | API audit events | Orchestration Layer wrapper (run audit) |
| `agents/index.json` | Worker | Registry rebuild | — |

### 2.2 Status Writer Invariant

**[ІНВАРІАНТ]** `status.json` має рівно **два** дозволені writers:

1. **Worker** — лише для початкового запису `{status: "requested"}`
2. **Orchestration Layer wrapper** — для всіх наступних transitions (`queued`, `running`, `completed`, `failed`)

**Mastra НЕ пише status.json.** Mastra повертає результати Orchestration Layer, який оновлює status.

### 2.3 Proposal Status Transitions

| Transition | Writer | Механізм |
|-----------|--------|---------|
| → `pending` | Orchestration Layer wrapper | Proposal creation під час run |
| `pending` → `approved` / `rejected` | Worker | Owner action через API |
| `approved` → `applying` | Worker | Apply Engine |
| `applying` → `applied` | Worker | Successful git commit |
| `applying` → `failed` | Worker | Git commit error |
| `pending` → `auto_approved` | Worker | Auto-approve rule match |
| `pending` → `expired` | Worker (cron) | TTL check |

---

## 3. Read Authority Matrix

### 3.1 Хто читає MinIO

| Компонент | Що читає | Як | Навіщо |
|----------|---------|-----|--------|
| **Worker** | Все (MinIO) | S3 API (direct) | Proxy для frontend; apply engine |
| **Orchestration Layer wrapper** | `_agent.md`, sources (MinIO) | S3 API (direct) | Context для agent execution |
| **Orchestration Layer wrapper** | `memory/<agentId>/` (git monorepo) | Gateway API `/memory/:agentId/read` | Завантаження пам'яті Шару 1 перед виконанням |
| **Mastra** | sources | Через tool: `read-context` | Agent reasoning |
| **Mastra** | `memory/<agentId>/` (Шар 1) | Через tool: `read-memory()` | Відновлення контексту між запусками |
| **Optimizer agent** | `logic/<agentId>/`, `runs/` (явний запит) | Через tools | Аналіз для propose-logic-update |
| **Frontend** | **Нічого напряму** | Через Worker API | Projection layer |
| **FastAPI** | **Нічого** | — | Ізольований NLM proxy |

### 3.2 Frontend Read Path

**[ІНВАРІАНТ]** Frontend **ніколи** не читає MinIO напряму.

```
Frontend → Worker (HTTPS) → MinIO (S3 API) → Response → Worker → Frontend
```

Frontend оперує **API responses**, не MinIO objects. Це забезпечує:
- Auth enforcement на Worker level
- Response transformation (MinIO JSON → API JSON)
- Rate limiting
- Audit logging

---

## 4. Anti-Patterns

### 4.1 Заборонені writes

| Компонент | НЕ повинен писати | Причина |
|----------|------------------|---------|
| **Mastra** | `status.json` | Status writer = Orchestration Layer wrapper |
| **Mastra** | `proposals/*.json` напряму | Proposals створює Orchestration Layer wrapper |
| **Frontend** | будь-що у MinIO | Frontend = projection layer |
| **FastAPI** | будь-що у MinIO | FastAPI = ізольований NLM proxy |
| **Orchestration Layer** | `_agent.md` | Agent definition = Owner authority |
| **Orchestration Layer** | `agents/index.json` | Registry = Worker authority |

### 4.2 Заборонені reads

| Компонент | НЕ повинен читати | Причина |
|----------|------------------|---------|
| **Frontend** | MinIO напряму | Auth bypass, coupling |
| **Frontend** | Orchestration Layer API | Vendor coupling |
| **FastAPI** | MinIO | Ізольований сервіс |

---

## 5. Data Lifecycle

### 5.1 Retention

| Data Category | Retention | Cleanup |
|--------------|-----------|---------|
| Agent definitions (`_agent.md`) | Permanent | Owner deletes |
| Run logs (`runs/`) | Configurable (default: 90 days) | Cron cleanup |
| Proposals (applied) | Permanent (audit trail) | — |
| Proposals (expired/rejected) | 30 days | Cron cleanup |
| Audit log | Permanent | — |
| Agent memory Layer 1 (`snapshot.md`, `facts.md`, `open_loops.md`) | Permanent; старі факти → git-history (eviction при >HARD LIMIT) | Gateway eviction |
| Agent memory Layer 2 (`runs/`, `timeline/`) | 90 днів у git monorepo; потім MinIO deep storage | Cron |
| Agent logic (`logic/<agentId>/current.*`) | Permanent | — |
| Agent logic versions (`logic/<agentId>/versions/`) | Permanent (незмінний архів) | — |

### 5.2 Consistency Model

**[ПРИНЦИП]** MinIO забезпечує **eventual consistency** для reads після writes. Для runtime це означає:

- Status.json write → poll може показати old value протягом ~1-2с
- Це прийнятно для 5с polling interval
- Step result write → status.json update: **порядок гарантований** Orchestration Layer (sequential steps)

---

## 6. Recovery

### 6.1 MinIO recovery

**[ІНВАРІАНТ]** Якщо MinIO втрачає дані — система втрачає дані. MinIO є **єдиним** canonical storage.

Мітигація:
- MinIO replication (виходить за межі цього документа)
- MinIO backup policy (виходить за межі цього документа)

### 6.2 Component recovery

| Ситуація | Recovery | Дані втрачені? |
|---------|----------|---------------|
| Mastra restart | Перезапуск current step | **Ні** — Mastra stateless |
| Orchestration Layer restart | Durable execution replay | **Ні** — replay з MinIO checkpoints |
| Worker restart | Frontend retries | **Ні** — Worker stateless |
| MinIO restart | Service unavailable temporarily | **Ні** — data persisted |
| MinIO data loss | **Катастрофа** | **Так** — canonical data lost |

---

## Див. також

- **RUNTIME_ARCHITECTURE_CANONICAL.md** — загальна canonical архітектура
- **ORCHESTRATION_LAYER_ABSTRACTION.md** — абстракція Orchestration Layer
- **RUN_LIFECYCLE_CANONICAL.md** — lifecycle стани run
- **EXECUTION_PIPELINE_CANONICAL.md** — pipeline виконання
- **RUNTIME_ARCHITECTURE_INDEX.md** — master index

---

## Семантичні зв'язки

**Цей документ деталізує:**
- [[ARCHITECTURE_ROOT]] — аксіоми A1 (storage authority), A5 (gateway entrypoint), A6 (frontend isolation)

**Цей документ залежить від:**
- [[AGENT_MEMORY_GIT_DIFFMEM_V1]] — git monorepo як окремий storage tier (memory/, logic/)
- [[INBOX_ТА_PROPOSAL_АРХІТЕКТУРА]] — proposal lifecycle визначає transitions статусів

**Від цього документа залежать:**
- [[EXECUTION_PIPELINE_CANONICAL]] — хто що пише на кожній фазі pipeline
- [[RUNTIME_ARCHITECTURE_CANONICAL]] — загальна authority model
- [[ORCHESTRATION_LAYER_ABSTRACTION]] — Hatchet wrapper як status writer
- [[RUN_LIFECYCLE_CANONICAL]] — status.json writer contract

---

*Цей документ є канонічною специфікацією Storage Authority Model. Він vendor-agnostic за задумом.*
