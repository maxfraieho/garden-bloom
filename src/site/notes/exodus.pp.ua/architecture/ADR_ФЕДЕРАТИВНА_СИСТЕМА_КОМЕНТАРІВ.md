---
{"tags":["domain:arch","status:canonical","format:adr","feature:proposal"],"created":"2026-01-16","updated":"2026-02-21","tier":2,"title":"ADR_ФЕДЕРАТИВНА_СИСТЕМА_КОМЕНТАРІВ","dg-publish":true,"dg-metatags":null,"dg-home":null,"permalink":"/exodus.pp.ua/architecture/ADR_ФЕДЕРАТИВНА_СИСТЕМА_КОМЕНТАРІВ/","dgPassFrontmatter":true,"noteIcon":""}
---

# ADR: Федеративна система коментарів

> Дата: 2026-01-16
> Статус: Прийнято
> Автор: Lovable.dev Agent
> Мова: Українська (канонічна)

---

## Резюме

Цей документ фіксує архітектурні рішення для впровадження федеративної системи коментарів та анотацій для Digital Garden exodus.pp.ua. Ключова мета: **відібрані коментарі стають частиною знань статті, доступних AI-моделям через MCP**.

---

## Рішення 1: Рівень зберігання

**Рішення**: **Варіант Б — MinIO (канонічне сховище) + Cloudflare KV (індекс/кеш)**

**Обґрунтування**:
- MinIO вже використовується для зберігання MCP-сесій — повторне використання існуючої інфраструктури
- KV забезпечує швидкий пошук стаття→коментарі (< 10 мс) без сканування MinIO
- Коментарі незмінні після створення (append-only; підходить для S3-патерну)
- Бюджетно: KV ~$5/міс, MinIO self-hosted = $0

**Компроміси**:
- ✅ Швидке читання через KV-індекс
- ✅ Надійне зберігання в MinIO
- ⚠️ Потребує синхронізації індексу (управляється Worker)
- ⚠️ Eventual consistency між KV і MinIO

**Відхилені варіанти**:
- Варіант А (тільки MinIO): повільні операції list, немає кешування
- Варіант В (Durable Objects): надмірна складність для MVP, +$5-10/міс

---

## Рішення 2: Структура потоків коментарів

**Рішення**: **Варіант Б — Однорівневі відповіді (стиль Twitter)**

**Обґрунтування**:
- Необмежена вкладеність ускладнює контекст для AI-моделей
- Плаский список втрачає контекст розмови
- Однорівнева структура (батько → відповіді) балансує структуру і читабельність
- AI чітко розуміє зв'язок «коментар → відповідь»

**Компроміси**:
- ✅ Чиста структура для MCP-експорту
- ✅ Проста реалізація UI
- ⚠️ Неможлива відповідь на відповідь (прийнятно для бази знань)

---

## Рішення 3: Оновлення в реальному часі

**Рішення**: **Варіант В — Без реального часу (оновити сторінку для нових коментарів)**

**Обґрунтування**:
- Digital Garden — не застосунок для чату
- Частота коментарів низька (куратування знань, не соцмережа)
- SSE ускладнює Worker (потрібні Durable Objects для справжнього реального часу)
- Пріоритет MVP: коректність над швидкістю

**Компроміси**:
- ✅ Проста реалізація
- ✅ Без витрат на WebSocket/DO
- ⚠️ Потрібно оновлювати сторінку для нових коментарів (прийнятно)

**Майбутнє**: Додати polling (30 с) у фазі 2 за потреби.

---

## Рішення 4: Процес куратування Owner'ом

**Рішення**: **Варіант В — Окремий шар (коментарі в окремих файлах, включаються в MCP-експорт)**

**Обґрунтування**:
- Зміна оригінальних Markdown-файлів є деструктивною
- Окреме зберігання дозволяє вибіркове куратування для MCP
- Owner може обирати, які коментарі включити в кожен експорт
- MCP endpoint динамічно об'єднує коментарі з контекстом

**Реалізація**:
1. Коментарі зберігаються у MinIO: `comments/{articleSlug}/`
2. Owner позначає коментарі як `approved` або `merged`
3. Модальне вікно Експорту: прапорець "Включити затверджені коментарі"
4. MCP-ресурс включає секцію коментарів після статті

**Компроміси**:
- ✅ Неруйнівний (оригінальний Markdown незмінний)
- ✅ Гнучке куратування для кожного експорту
- ⚠️ Коментарі не видимі в статичному Markdown-експорті (тільки MCP)

---

## Рішення 5: Патерн UI/UX

**Рішення**: **Варіант Г — Гібридний (анотації + секція коментарів)**

**Обґрунтування**:
- Бази знань виграють від вбудованих анотацій до конкретного тексту
- Загальна дискусія потребує окремої секції коментарів
- Mobile-friendly: popup анотацій при виділенні, коментарі при скролі
- Відповідає ментальній моделі користувача: «виділення → анотація» і «скрол → обговорення»

**Компоненти**:
1. `CommentSection` — під статтею (blog-стиль)
2. `AnnotationPopup` — при виділенні тексту (Hypothesis-стиль)
3. `AnnotationHighlight` — візуальне маркування анотованого тексту

**Компроміси**:
- ✅ Краще з обох підходів
- ✅ Працює на desktop і mobile
- ⚠️ Складніша реалізація (2 режими взаємодії)

---

## Рішення 6: Протокол федерації (майбутнє)

**Рішення**: **Варіант А — Власний HTTP + підписи Ed25519 (легковаговий)**

**Обґрунтування**:
- ActivityPub потребує управління акторами та WebFinger discovery
- Matrix потребує homeserver (stateful backend)
- Власний протокол підходить для Worker-to-Worker архітектури
- Ed25519 доступний через Web Crypto API у Workers

**Протокол (Фаза 2/3)**:
```
Discovery: GET /.well-known/garden-federation.json
Submit:    POST /federation/inbox (підписаний payload)
Verify:    Ed25519 публічний ключ з MinIO
```

**Компроміси**:
- ✅ Мінімальні накладні витрати
- ✅ Без зовнішніх залежностей
- ⚠️ Несумісний з Mastodon/Fediverse (прийнятно для garden-to-garden)

**Відкладено**: Повна федерація у фазі 2.

---

## Моделі даних

### TypeScript-інтерфейси

```typescript
// Статуси коментаря: pending → approved → merged (опціонально)
export type CommentStatus = 'pending' | 'approved' | 'rejected' | 'merged';
export type CommentOrigin = 'local' | 'federated';

export interface CommentAuthor {
  id: string;          // UUID або session ID
  name: string;        // Ім'я для відображення
  domain: string;      // Домен походження (exodus.pp.ua)
  isOwner: boolean;    // Прапорець Owner
}

export interface Comment {
  id: string;                 // UUIDv4
  articleSlug: string;        // Стаття, до якої належить коментар
  parentId: string | null;    // null = корінь, інакше ID батьківського коментаря
  author: CommentAuthor;
  content: string;            // Markdown-вміст
  createdAt: string;          // ISO 8601
  updatedAt: string | null;   // ISO 8601 при редагуванні
  status: CommentStatus;
  origin: CommentOrigin;
  originDomain?: string;      // Якщо федерований
  annotationId?: string;      // Зв'язок з анотацією (якщо inline-коментар)
}

export interface Annotation {
  id: string;              // UUIDv4
  articleSlug: string;
  highlightedText: string; // Виділений фрагмент тексту
  startOffset: number;     // Символьний offset у статті
  endOffset: number;
  paragraphIndex: number;  // Номер абзацу (для надійності)
  commentId: string;       // Пов'язаний коментар
  createdAt: string;
}
```

---

## Структура MinIO bucket

```
garden-data/
├── comments/
│   └── {articleSlug}/
│       └── {commentId}.json
│
├── annotations/
│   └── {articleSlug}/
│       └── {annotationId}.json
│
├── index/
│   └── comments/
│       └── {articleSlug}.json   # Індекс коментарів для швидкого пошуку
│
└── federation/                   # Фаза 2+
    ├── peers/
    │   └── {domain}/
    │       └── pubkey.pem
    └── inbox/
        └── {eventId}.json
```

---

## Фази реалізації

### Фаза 1: MVP

**Обсяг**:
1. ✅ Зберігання коментарів у MinIO + KV-індекс
2. ✅ Базовий CRUD API у Worker
3. ✅ Компонент `CommentSection` під статтями
4. ✅ Модерація Owner (approve/reject)
5. ✅ Включення коментарів у MCP-експорт

**Поза MVP**:
- ❌ Анотації (Фаза 2)
- ❌ Федерація (Фаза 2-3)
- ❌ UI для коментарів гостей (Фаза 2)

### Фаза 2: Анотації + UX для гостей

- Шар анотацій з виділенням тексту
- Форма коментаря гостя через AccessZone
- Polling в реальному часі (30 с)

### Фаза 3: Федерація

- `/.well-known/garden-federation.json`
- Endpoint `/federation/inbox`
- Верифікація Ed25519 підписів
- Виявлення та затвердження peers

---

## Критерії успіху

| Критерій | MVP | Фаза 2 | Фаза 3 |
|----------|-----|---------|--------|
| Owner може коментувати статті | ✅ | ✅ | ✅ |
| Гість може коментувати через зону | — | ✅ | ✅ |
| Коментарі зберігаються в MinIO | ✅ | ✅ | ✅ |
| Owner може approve/reject | ✅ | ✅ | ✅ |
| MCP-експорт включає коментарі | ✅ | ✅ | ✅ |
| Анотації в тексті | — | ✅ | ✅ |
| Федерація між gardens | — | — | ✅ |

---

## Семантичні зв'язки

**Цей документ спирається на:**
- [[exodus.pp.ua/architecture/КАНОНІЧНА_МОДЕЛЬ_АВТОРИТЕТУ_СХОВИЩА\|КАНОНІЧНА_МОДЕЛЬ_АВТОРИТЕТУ_СХОВИЩА]] — MinIO як canonical storage для коментарів
- [[exodus.pp.ua/architecture/АРХІТЕКТУРНИЙ_КОРІНЬ\|АРХІТЕКТУРНИЙ_КОРІНЬ]] — A5 Gateway як єдина точка входу
- [[exodus.pp.ua/architecture/ІНВАРІАНТИ_ГРАФУ_ЗНАНЬ\|ІНВАРІАНТИ_ГРАФУ_ЗНАНЬ]] — integrity правила для нових компонентів

**Суміжні документи:**
- [[exodus.pp.ua/backend/КОНТРАКТИ_API_V1\|КОНТРАКТИ_API_V1]] — API schemas для endpoints коментарів
- [[exodus.pp.ua/architecture/БЕЗПЕКА_СИСТЕМИ\|БЕЗПЕКА_СИСТЕМИ]] — access control для коментування

---

*ADR зафіксовує архітектурні рішення для федеративної системи коментарів Garden Bloom / exodus.pp.ua.*
